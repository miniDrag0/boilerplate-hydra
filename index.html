<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Viking 1.0.0</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Using FontAwesome for the logout icon if needed, but text for now -->
</head>
<body>

    <!-- Header -->
    <header class="main-header">
        <div class="logo-section">
            <img src="viking.png" alt="Viking logo" class="logo-img">
            <h1>Viking 1.0.0</h1>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        
        <!-- Top Action Buttons -->
        <div class="top-actions">
            <button class="btn btn-pill" id="start-bcel-btn">Start BCEL</button>
        </div>

        <!-- Form Card -->
        <div class="card">
            <div class="form-group">
                <label>App Mode:</label>
                <div style="margin-top: 5px;">
                    <label style="display: inline-block; margin-right: 15px; font-weight: normal;">
                        <input type="radio" name="app-mode" value="BCEL" checked> BCEL
                    </label>
                    <label style="display: inline-block; font-weight: normal;">
                        <input type="radio" name="app-mode" value="LDB"> LDB
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label>PORT:</label>
                <input type="text" class="form-control" id="port-input" placeholder="Enter port example 4723 .. 472x">
            </div>

            <div class="form-group">
                <label>DEVICE_ID:</label>
                <input type="text" class="form-control disabled" id="device-id-input" value="Device ID will be auto-filled" readonly>
            </div>

            <div class="form-group">
                <label>ANDROID VERSION:</label>
                <input type="text" class="form-control disabled" id="android-version-input" value="Android Version will be auto-filled" readonly>
            </div>

            <!-- BCEL Specific Fields -->
            <div id="bcel-fields">
                <div class="form-group">
                    <label>Upload CSV Account Data (Login):</label>
                    <input type="file" class="form-control" id="bcel-csv" accept=".csv">
                    <small class="form-text text-muted">
                        Format: Password, MotherBirthday, HouseNumber, PhoneFirst
                    </small>
                </div>
                <div class="form-group">
                    <label>Upload CSV Transfer List:</label>
                    <input type="file" class="form-control" id="bcel-transfer-csv" accept=".csv">
                    <small class="form-text text-muted">
                        Format: No, Nama Akun, Nomor Akun, Amount
                    </small>
                </div>
            </div>

            <!-- LDB Specific Fields -->
            <div id="ldb-fields" style="display: none;">
                <div class="form-group">
                    <label>Password:</label>
                    <div style="position: relative;">
                        <input type="password" class="form-control" id="ldb-password" placeholder="Enter Password" style="padding-right: 40px;">
                        <button type="button" id="toggle-ldb-password" style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); border: none; background: none; cursor: pointer;">
                            üëÅÔ∏è
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Middle Action Buttons -->
        <div class="middle-actions">
            <button class="btn btn-default" id="scrcpy-btn">Tampilkan Layar</button>
            <button class="btn btn-default">Report Problem</button>
            <button class="btn btn-default" id="reset-btn">Reset</button>
            <button class="btn btn-default" id="copy-btn">Copy</button>
            <button class="btn btn-default" id="save-btn">Save</button>
        </div>

        <!-- Log Area -->
        <div class="log-area">
            <!-- Content goes here -->
        </div>

    </div>

    <!-- Device Selection Modal -->
    <div id="deviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Select Device</h2>
            </div>
            <div id="deviceListContainer">
                <ul class="device-list" id="device-list">
                    <!-- Devices will be added here dynamically -->
                </ul>
            </div>
            <div style="text-align: right; margin-top: 10px;">
                <button class="btn btn-default" id="cancel-device-selection">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        const startBtn = document.getElementById('start-bcel-btn');
        const scrcpyBtn = document.getElementById('scrcpy-btn');
        const resetBtn = document.getElementById('reset-btn');
        const copyBtn = document.getElementById('copy-btn');
        const saveBtn = document.getElementById('save-btn');
        
        // Mode handling
        const modeRadios = document.getElementsByName('app-mode');
        const bcelFields = document.getElementById('bcel-fields');
        const ldbFields = document.getElementById('ldb-fields');
        
        // Password Toggle Logic
        function setupPasswordToggle(inputId, toggleId) {
            const input = document.getElementById(inputId);
            if (!input) return; // Guard in case element is missing (like bcel-password now)
            const toggle = document.getElementById(toggleId);
            
            toggle.addEventListener('click', () => {
                const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                input.setAttribute('type', type);
                toggle.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üîí';
            });
        }

        // setupPasswordToggle('bcel-password', 'toggle-bcel-password'); // Removed as bcel-password input is gone
        setupPasswordToggle('ldb-password', 'toggle-ldb-password');

        function getSelectedMode() {
            return document.querySelector('input[name="app-mode"]:checked').value;
        }

        // CSV Parser
        function parseCSV(text) {
            const lines = text.trim().split(/\r?\n/);
            if (lines.length < 1) return [];
            
            const data = [];
            let startIndex = 0;
            
            // Check for header
            if (lines[0]) {
                const firstLine = lines[0].toLowerCase();
                if (firstLine.includes('password') || firstLine.includes('mother')) {
                    startIndex = 1; // Skip header
                }
            }

            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Detect delimiter
                const delimiter = line.includes(';') ? ';' : ',';
                const parts = line.split(delimiter).map(p => p.trim());
                
                if (parts.length >= 4) {
                    data.push({
                        passwordApp: parts[0],
                        motherBirthday: parts[1],
                        houseNumber: parts[2],
                        phoneFirst: parts[3]
                    });
                }
            }
            return data;
        }

        let batchQueue = [];
        let isBatchRunning = false;
        let isRunning = false;
        let pendingArgs = null; // Store all args during device selection

        function processNextInBatch() {
            if (batchQueue.length === 0) {
                const logArea = document.querySelector('.log-area');
                logArea.innerHTML += `<div>Batch processing finished.</div>`;
                isBatchRunning = false;
                startBtn.textContent = 'Start BCEL';
                startBtn.classList.remove('btn-logout');
                startBtn.classList.add('btn-pill');
                startBtn.disabled = false;
                return;
            }

            const currentData = batchQueue.shift();
            const logArea = document.querySelector('.log-area');
            logArea.innerHTML += `<div>Starting batch item... (Queue: ${batchQueue.length} remaining)</div>`;

            // Merge with global args (port, deviceId)
            // We need to retrieve the original port/deviceId from when Start was clicked.
            // Let's store them in a global context or pass them.
            
            const args = { 
                ...currentData,
                port: pendingArgs ? pendingArgs.port : document.getElementById('port-input').value.trim(),
                deviceId: document.getElementById('device-id-input').value === 'Device ID will be auto-filled' ? null : document.getElementById('device-id-input').value,
                mode: 'BCEL',
                transferCsvPath: pendingArgs ? pendingArgs.transferCsvPath : null,
                transferCsvContent: pendingArgs ? pendingArgs.transferCsvContent : null
            };

            ipcRenderer.send('run-mutasi-bcel', args);
        }

        const readFileAsync = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = (err) => reject(err);
            reader.readAsText(file);
        });

        startBtn.addEventListener('click', () => {
            console.log('Start button clicked');
            const logArea = document.querySelector('.log-area');
            
            try {
                const portInput = document.getElementById('port-input');
                const port = portInput.value.trim();
                const mode = getSelectedMode();
                
                if (!isRunning) {
                    console.log(`Attempting to start in ${mode} mode`);
                    
                    // Validation Logic
                    if (mode === 'BCEL') {
                        const csvInput = document.getElementById('bcel-csv');
                        const transferCsvInput = document.getElementById('bcel-transfer-csv');

                        if (!csvInput.files.length) {
                            alert('Please upload the Account Data CSV file.');
                            return;
                        }
                        if (!transferCsvInput.files.length) {
                            alert('Please upload the Transfer List CSV file.');
                            return;
                        }

                        const csvFile = csvInput.files[0];
                        const transferFile = transferCsvInput.files[0];
                        const transferCsvPath = transferFile.path;

                        Promise.all([
                            readFileAsync(csvFile),
                            readFileAsync(transferFile)
                        ]).then(([addressCsvText, transferCsvText]) => {
                            try {
                                const data = parseCSV(addressCsvText);
                                if (data.length === 0) {
                                    alert('No valid data found in CSV. Please ensure format: Password, MotherBirthday, HouseNumber, PhoneFirst');
                                    return;
                                }

                                console.log(`Parsed ${data.length} rows from CSV`);
                                const logAreaRef = document.querySelector('.log-area'); // Re-select to be safe
                                logAreaRef.innerHTML += `<div>Loaded ${data.length} accounts from CSV. Starting batch...</div>`;
                                
                                // Initialize Batch
                                batchQueue = data;
                                isBatchRunning = true;
                                isRunning = true;
                                
                                // Capture initial args (port etc) plus transfer info
                                pendingArgs = { port, mode, transferCsvPath, transferCsvContent: transferCsvText }; 

                                // UI State
                                startBtn.textContent = `Stop ${mode}`;
                                startBtn.classList.remove('btn-pill');
                                startBtn.classList.add('btn-logout');

                                processNextInBatch();
                            } catch (err) {
                                console.error('Error processing CSV:', err);
                                alert('Error processing CSV: ' + err.message);
                            }
                        }).catch(err => {
                            console.error('Error reading files:', err);
                            alert('Error reading CSV files.');
                        });
                        return;

                    } else {
                        // LDB Logic (unchanged)
                        const pass = document.getElementById('ldb-password').value.trim();
                        if (!pass) {
                            alert('Password is mandatory for LDB mode.');
                            return;
                        }
                        
                        // Start logic for LDB
                        console.log(`Start ${mode} button clicked`);
                        
                        let message = `Starting ${mode}...`;
                        if (port) {
                            message += ` (Port: ${port})`;
                        }
                        logArea.innerHTML += `<div>${message}</div>`;
                        
                        const args = { 
                            port, 
                            mode,
                            password: pass
                        };

                        ipcRenderer.send('run-mutasi-bcel', args);

                        // Change UI to Stop state
                        isRunning = true;
                        startBtn.textContent = `Stop ${mode}`;
                        startBtn.classList.remove('btn-pill');
                        startBtn.classList.add('btn-logout');
                    }

                } else {
                    // Stop logic
                    console.log(`Stop ${mode} button clicked`);
                    logArea.innerHTML += `<div>Stopping ${mode}...</div>`;
                    
                    // If batch running, clear queue
                    if (isBatchRunning) {
                        batchQueue = [];
                        isBatchRunning = false;
                        logArea.innerHTML += `<div>Batch cancelled.</div>`;
                    }

                    ipcRenderer.send('stop-mutasi-bcel');
                    startBtn.disabled = true; // Prevent double clicks while stopping
                }
            } catch (err) {
                console.error('Error in start button handler:', err);
                alert('An error occurred: ' + err.message);
            }
        });

        // Listen for process finished event
        ipcRenderer.on('process-finished', (event, code) => {
             // If batch is running, process next
             if (isBatchRunning) {
                 // Delay slightly to ensure cleanup?
                 setTimeout(() => {
                     processNextInBatch();
                 }, 2000); // 2 second delay between runs
                 return;
             }

             isRunning = false;
             const mode = getSelectedMode();
             startBtn.textContent = `Start ${mode}`;
             startBtn.classList.remove('btn-logout');
             startBtn.classList.add('btn-pill');
             startBtn.disabled = false;
        });

        ipcRenderer.on('device-info-update', (event, info) => {
            console.log('Received device info update:', info); // Add logging
            if (info.deviceId) {
                const deviceInput = document.getElementById('device-id-input');
                deviceInput.value = info.deviceId;
                // Force UI update visual check
                deviceInput.setAttribute('value', info.deviceId);
            }
            if (info.androidVersion) {
                const versionInput = document.getElementById('android-version-input');
                versionInput.value = info.androidVersion;
                versionInput.setAttribute('value', info.androidVersion);
            }
        });

        ipcRenderer.on('command-output', (event, message) => {
            const logArea = document.querySelector('.log-area');
            // Simple text escape to prevent HTML injection if needed, though usually safe from stdout
            const div = document.createElement('div');
            div.textContent = message;
            logArea.appendChild(div);
            // Auto scroll to bottom
            logArea.scrollTop = logArea.scrollHeight;
        });

        // Device Selection Logic
        ipcRenderer.on('request-device-selection', (event, { devices, originalArgs }) => {
            // Store original args to resend later
            pendingArgs = originalArgs;

            // Clear list
            deviceList.innerHTML = '';
            
            devices.forEach(device => {
                const li = document.createElement('li');
                li.className = 'device-item';
                
                const idSpan = document.createElement('div');
                idSpan.className = 'device-item-id';
                idSpan.textContent = device.id;
                
                const modelSpan = document.createElement('div');
                modelSpan.className = 'device-item-model';
                modelSpan.textContent = `Model: ${device.model || 'Unknown'}`;

                li.appendChild(idSpan);
                li.appendChild(modelSpan);

                li.addEventListener('click', () => {
                    // User selected this device
                    deviceModal.style.display = 'none';
                    const logArea = document.querySelector('.log-area');
                    logArea.innerHTML += `<div>Selected device: ${device.id}</div>`;
                    
                    // Send run command again with selected device and preserved args
                    const newArgs = { ...pendingArgs, deviceId: device.id };
                    ipcRenderer.send('run-mutasi-bcel', newArgs);
                });

                deviceList.appendChild(li);
            });

            // Show modal
            deviceModal.style.display = 'block';
        });

        cancelDeviceSelectionBtn.addEventListener('click', () => {
            deviceModal.style.display = 'none';
            const logArea = document.querySelector('.log-area');
            logArea.innerHTML += `<div>Device selection cancelled.</div>`;
            
            // Reset start button
            isRunning = false;
            const mode = getSelectedMode();
            startBtn.textContent = `Start ${mode}`;
            startBtn.classList.remove('btn-logout');
            startBtn.classList.add('btn-pill');
            startBtn.disabled = false;
        });

        // Close modal if clicked outside
        window.onclick = function(event) {
            if (event.target == deviceModal) {
                cancelDeviceSelectionBtn.click();
            }
        }


        resetBtn.addEventListener('click', () => {
            console.log('Reset button clicked');
            document.querySelector('.log-area').innerHTML = '';
        });

        copyBtn.addEventListener('click', () => {
            console.log('Copy button clicked');
            const logContent = document.querySelector('.log-area').innerText;
            if (!logContent) {
                alert('Nothing to copy!');
                return;
            }
            navigator.clipboard.writeText(logContent).then(() => {
                alert('Log copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                alert('Failed to copy log');
            });
        });

        saveBtn.addEventListener('click', () => {
            console.log('Save button clicked');
            const logContent = document.querySelector('.log-area').innerText;
            if (!logContent) {
                alert('Nothing to save!');
                return;
            }
            ipcRenderer.send('save-log', logContent);
        });

        scrcpyBtn.addEventListener('click', () => {
            console.log('Tampilkan Layar button clicked');
            const deviceId = document.getElementById('device-id-input').value;
            const logArea = document.querySelector('.log-area');
            logArea.innerHTML += '<div>Launching scrcpy...</div>';
            
            // Pass the value directly, avoiding the "Device ID will be auto-filled" placeholder if it's there
            const targetDevice = deviceId === 'Device ID will be auto-filled' ? null : deviceId;
            ipcRenderer.send('run-scrcpy', { deviceId: targetDevice });
        });
    </script>
</body>
</html>
